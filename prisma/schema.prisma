// Waide - Database Schema
// Supabase PostgreSQL with pgvector extension for RAG

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email     String   @unique
  fullName  String?  @map("full_name")
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  workspaceMembers WorkspaceMember[]

  @@map("users")
}

// ============================================
// WORKSPACE & TEAM
// ============================================

model Workspace {
  id               String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name             String
  slug             String           @unique
  subscriptionTier SubscriptionTier @default(FREE) @map("subscription_tier")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  members       WorkspaceMember[]
  brandPersonas BrandPersona[]

  @@map("workspaces")
}

model WorkspaceMember {
  id          String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  workspaceId String        @map("workspace_id") @db.Uuid
  userId      String        @map("user_id") @db.Uuid
  role        WorkspaceRole @default(MEMBER)
  createdAt   DateTime      @default(now()) @map("created_at")

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@map("workspace_members")
}

enum SubscriptionTier {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================
// BRAND PERSONA (Brain Module)
// ============================================

model BrandPersona {
  id                    String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  workspaceId           String   @map("workspace_id") @db.Uuid
  name                  String
  description           String?
  toneVoiceSettings     Json     @default("{}") @map("tone_voice_settings")
  // Example: { formality: 0.7, humor: 0.3, enthusiasm: 0.8, empathy: 0.6 }
  basePromptInstruction String?  @map("base_prompt_instruction") @db.Text
  targetAudience        String?  @map("target_audience")
  brandValues           String[] @map("brand_values")
  isActive              Boolean  @default(true) @map("is_active")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  workspace      Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  knowledgeBases KnowledgeBase[]

  @@map("brand_personas")
}

// ============================================
// KNOWLEDGE BASE (RAG with pgvector)
// ============================================

model KnowledgeBase {
  id           String                      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  personaId    String                      @map("persona_id") @db.Uuid
  title        String?
  contentChunk String                      @map("content_chunk") @db.Text
  embedding    Unsupported("vector(1536)")?
  // 1536 dimensions for OpenAI text-embedding-ada-002
  // Use Unsupported for pgvector type
  metadata     Json                        @default("{}")
  // Example: { source: "website", url: "...", page: 1 }
  sourceType   KnowledgeSourceType         @default(MANUAL) @map("source_type")
  createdAt    DateTime                    @default(now()) @map("created_at")
  updatedAt    DateTime                    @updatedAt @map("updated_at")

  // Relations
  persona BrandPersona @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@map("knowledge_bases")
}

enum KnowledgeSourceType {
  MANUAL // User typed content
  FILE_UPLOAD // PDF, DOCX, etc.
  WEBSITE // Crawled from URL
  SOCIAL // From social media
  API // From external API
}

// ============================================
// CONTENT (Campaign Posts)
// ============================================

model Content {
  id          String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  workspaceId String        @map("workspace_id") @db.Uuid
  personaId   String?       @map("persona_id") @db.Uuid
  topic       String
  caption     String        @db.Text
  imageUrl    String?       @map("image_url")
  imagePrompt String?       @map("image_prompt") @db.Text
  hashtags    String[]      @default([])
  status      ContentStatus @default(DRAFT)
  scheduledAt DateTime?     @map("scheduled_at")
  publishedAt DateTime?     @map("published_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  analytics Analytics[]

  @@index([workspaceId])
  @@map("contents")
}

enum ContentStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
}

// ============================================
// ANALYTICS (Performance Metrics)
// ============================================

model Analytics {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contentId   String   @map("content_id") @db.Uuid
  impressions Int      @default(0)
  likes       Int      @default(0)
  comments    Int      @default(0)
  shares      Int      @default(0)
  clicks      Int      @default(0)
  date        DateTime @default(now())
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([date])
  @@map("analytics")
}
